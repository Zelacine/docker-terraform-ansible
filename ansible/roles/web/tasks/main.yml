---
- name: Ensure nginx container exists
  community.docker.docker_container_info:
    name: "{{ nginx_container_name }}"
  register: nginx_info

- name: Ensure php-fpm container exists
  community.docker.docker_container_info:
    name: "{{ php_fpm_container_name }}"
  register: php_info

- name: Fail if required containers are missing
  ansible.builtin.fail:
    msg: >-
      One or more containers ({{ nginx_container_name }}, {{ php_fpm_container_name }}) were
      not found. Make sure Terraform has created them.
  when: not (nginx_info.exists and php_info.exists)

- name: Ensure temporary render directory exists
  ansible.builtin.file:
    path: "{{ temp_render_dir }}"
    state: directory
    mode: "0700"

- name: Render nginx configuration locally
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: "{{ temp_render_dir }}/nginx.conf"
    mode: "0600"
  register: rendered_nginx

- name: Render application index locally
  ansible.builtin.template:
    src: index.php.j2
    dest: "{{ temp_render_dir }}/index.php"
    mode: "0600"
  register: rendered_index

- name: Render logrotate configuration locally
  ansible.builtin.template:
    src: logrotate-nginx.j2
    dest: "{{ temp_render_dir }}/logrotate-nginx"
    mode: "0600"
  register: rendered_logrotate

- name: Push nginx configuration into container
  community.docker.docker_container_copy:
    name: "{{ nginx_container_name }}"
    src: "{{ temp_render_dir }}/nginx.conf"
    dest_path: "{{ nginx_conf_path }}"
  when: rendered_nginx is changed
  notify: restart nginx container

- name: Push logrotate configuration into container
  community.docker.docker_container_copy:
    name: "{{ nginx_container_name }}"
    src: "{{ temp_render_dir }}/logrotate-nginx"
    dest_path: "{{ logrotate_path }}"
  when: rendered_logrotate is changed
  notify: restart nginx container

- name: Push application index.php into php-fpm container
  community.docker.docker_container_copy:
    name: "{{ php_fpm_container_name }}"
    src: "{{ temp_render_dir }}/index.php"
    dest_path: "{{ php_web_root }}/index.php"
  when: rendered_index is changed
  notify:
    - restart php-fpm container
    - restart nginx container

- name: Ensure index ownership inside php container
  community.docker.docker_container_exec:
    container: "{{ php_fpm_container_name }}"
    command: "chown {{ container_web_user }}:{{ container_web_user }} {{ php_web_root }}/index.php"
  changed_when: false

- name: Check nginx configuration
  community.docker.docker_container_exec:
    container: "{{ nginx_container_name }}"
    command: "nginx -t"
  register: nginx_test
  changed_when: false

- name: Display nginx test output
  ansible.builtin.debug:
    msg: "{{ nginx_test.stdout }}"
